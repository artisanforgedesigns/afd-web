{% extends "base.html" %}

{% block content %}
<form method="POST" action="/save_settings" id="settings-form">
    <!-- Device Accounts Side by Side -->
    <div class="settings-layout">
        <div class="section">
            <h3>Switchbot Account</h3>
            <div class="form-group">
                <label for="switchbot_token" class="tooltip" data-tooltip="Get your API token from the SwitchBot app: Profile → Settings → App Version (tap 10 times) → Developer Options">Token:</label>
                <input type="text" id="switchbot_token" name="switchbot_token"
                       value="{{ settings.get('switchbot', {}).get('token', '') }}" required>
            </div>
            <div class="form-group">
                <label for="switchbot_secret" class="tooltip" data-tooltip="Get your API secret from the SwitchBot app: Profile → Settings → App Version (tap 10 times) → Developer Options">Secret:</label>
                <input type="text" id="switchbot_secret" name="switchbot_secret"
                       value="{{ settings.get('switchbot', {}).get('secret', '') }}" required>
            </div>
            <div class="form-group">
                <label for="switchbot_device_1_id" class="tooltip" data-tooltip="Find Device ID in SwitchBot app: tap on the device → Settings (gear icon) → Device Info">Device 1 ID:</label>
                <input type="text" id="switchbot_device_1_id" name="switchbot_device_1_id"
                       value="{{ settings.get('switchbot', {}).get('device_1_id', '') }}">
            </div>
            <div class="form-group">
                <label for="switchbot_device_2_id" class="tooltip" data-tooltip="Find Device ID in SwitchBot app: tap on the device → Settings (gear icon) → Device Info">Device 2 ID:</label>
                <input type="text" id="switchbot_device_2_id" name="switchbot_device_2_id"
                       value="{{ settings.get('switchbot', {}).get('device_2_id', '') }}">
            </div>
            <div class="form-group">
                <label for="switchbot_device_3_id" class="tooltip" data-tooltip="Find Device ID in SwitchBot app: tap on the device → Settings (gear icon) → Device Info">Device 3 ID:</label>
                <input type="text" id="switchbot_device_3_id" name="switchbot_device_3_id"
                       value="{{ settings.get('switchbot', {}).get('device_3_id', '') }}">
            </div>
            <div class="form-group">
                <label for="switchbot_device_4_id" class="tooltip" data-tooltip="Find Device ID in SwitchBot app: tap on the device → Settings (gear icon) → Device Info">Device 4 ID:</label>
                <input type="text" id="switchbot_device_4_id" name="switchbot_device_4_id"
                       value="{{ settings.get('switchbot', {}).get('device_4_id', '') }}">
            </div>
        </div>

        <div class="section">
            <h3>PiShock Account</h3>
            <div class="form-group">
                <label for="pishock_username" class="tooltip" data-tooltip="Your PiShock.com account username (required for API access)">Username:</label>
                <input type="text" id="pishock_username" name="pishock_username"
                       value="{{ settings.get('pishock', {}).get('username', '') }}" required>
            </div>
            <div class="form-group">
                <label for="pishock_api_key" class="tooltip" data-tooltip="Get your API key from PiShock.com: Account → API Key">API Key:</label>
                <input type="text" id="pishock_api_key" name="pishock_api_key"
                       value="{{ settings.get('pishock', {}).get('api_key', '') }}" required>
            </div>
            <div class="form-group">
                <label for="pishock_sharecode_1" class="tooltip" data-tooltip="Find share code on PiShock.com: select your device → Share Codes tab → create or copy existing code">Sharecode 1:</label>
                <input type="text" id="pishock_sharecode_1" name="pishock_sharecode_1"
                       value="{{ settings.get('pishock', {}).get('sharecode_1', '') }}">
            </div>
            <div class="form-group">
                <label for="pishock_sharecode_2" class="tooltip" data-tooltip="Find share code on PiShock.com: select your device → Share Codes tab → create or copy existing code">Sharecode 2:</label>
                <input type="text" id="pishock_sharecode_2" name="pishock_sharecode_2"
                       value="{{ settings.get('pishock', {}).get('sharecode_2', '') }}">
            </div>
            <div class="form-group">
                <label for="pishock_sharecode_3" class="tooltip" data-tooltip="Find share code on PiShock.com: select your device → Share Codes tab → create or copy existing code">Sharecode 3:</label>
                <input type="text" id="pishock_sharecode_3" name="pishock_sharecode_3"
                       value="{{ settings.get('pishock', {}).get('sharecode_3', '') }}">
            </div>
            <div class="form-group">
                <label for="pishock_sharecode_4" class="tooltip" data-tooltip="Find share code on PiShock.com: select your device → Share Codes tab → create or copy existing code">Sharecode 4:</label>
                <input type="text" id="pishock_sharecode_4" name="pishock_sharecode_4"
                       value="{{ settings.get('pishock', {}).get('sharecode_4', '') }}">
            </div>
        </div>
    </div>

    <!-- Contact Sensors and Custom Accessories Side by Side -->
    <div class="settings-layout">
        <div class="section">
            <h3>Contact Sensors</h3>
            {% for i in range(1, 5) %}
            <div class="form-group">
                <label for="contact_sensor_{{ i }}_id" class="tooltip" data-tooltip="Enter a SwitchBot Contact Sensor Device ID to trigger Modifier {{ i }} when opened, OR leave blank and use the API endpoint: GET/POST {{ request.host_url }}trigger{{ i }}">Sensor {{ i }} ID:</label>
                <div class="input-with-test-button">
                    <input type="text" id="contact_sensor_{{ i }}_id" name="contact_sensor_{{ i }}_id"
                           value="{{ settings.get('contact_sensors', {}).get('sensor_' + i|string + '_id', '') }}">
                    {% if settings.get('interface', {}).get('developer_mode', False) %}
                    <button type="button" class="test-button" onclick="testContactSensor({{ i }})">T</button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="section">
            <h3>Custom Accessories</h3>
            {% for i in range(1, 5) %}
            <div class="form-group">
                <label for="custom_{{ i }}_endpoint" class="tooltip" data-tooltip="HTTP API endpoint URL for custom accessory {{ i }}. Click PAYLOAD to configure request method and JSON body">Endpoint {{ i }}:</label>
                <div class="custom-endpoint-controls">
                    <input type="url" id="custom_{{ i }}_endpoint" name="custom_{{ i }}_endpoint"
                           value="{{ settings.get('custom_accessories', {}).get('endpoint_' + i|string, '') }}">
                    <button type="button" class="btn btn-secondary" onclick="editPayload({{ i }})">PAYLOAD</button>
                    {% if settings.get('interface', {}).get('developer_mode', False) %}
                    <button type="button" class="test-button" onclick="testCustomAccessory({{ i }})">T</button>
                    {% endif %}
                </div>
                <!-- Hidden fields for payload and method -->
                <input type="hidden" id="custom_{{ i }}_payload" name="custom_{{ i }}_payload"
                       value="{{ settings.get('custom_accessories', {}).get('payload_' + i|string, '{}') }}">
                <input type="hidden" id="custom_{{ i }}_method" name="custom_{{ i }}_method"
                       value="{{ settings.get('custom_accessories', {}).get('method_' + i|string, 'POST') }}">
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- AFD MagLock Device and Kill Switch Side by Side -->
    <div class="settings-layout">
        <div class="section">
            <h3>AFD MAGLOCK DEVICE</h3>
            <div class="form-group">
                <label for="lock_engage_webhook" class="tooltip" data-tooltip="eWeLink webhook url. Links will start with https://us-apia.coolkit.cc/v2/">Lock:</label>
                <div class="input-with-test-button">
                    <input type="url" id="lock_engage_webhook" name="lock_engage_webhook"
                           value="{{ settings.get('lock', {}).get('engage_webhook', '') }}">
                    {% if settings.get('interface', {}).get('developer_mode', False) %}
                    <button type="button" class="test-button" onclick="testMagLock('engage')">T</button>
                    {% endif %}
                </div>
            </div>
            <div class="form-group">
                <label for="lock_disengage_webhook" class="tooltip" data-tooltip="eWeLink webhook url. Links will start with https://us-apia.coolkit.cc/v2/">Unlock:</label>
                <div class="input-with-test-button">
                    <input type="url" id="lock_disengage_webhook" name="lock_disengage_webhook"
                           value="{{ settings.get('lock', {}).get('disengage_webhook', '') }}">
                    {% if settings.get('interface', {}).get('developer_mode', False) %}
                    <button type="button" class="test-button" onclick="testMagLock('disengage')">T</button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="section">
            <h3>Kill Switch</h3>
            <div class="form-group">
                <label for="killswitch_plug_id" class="tooltip" data-tooltip="SwitchBot Plug Device ID - when turned OFF, immediately stops the scene. Pair with a physical remote button in the SwitchBot app for emergency stop functionality">Plug ID:</label>
                <div class="input-with-test-button">
                    <input type="text" id="killswitch_plug_id" name="killswitch_plug_id"
                           value="{{ settings.get('killswitch', {}).get('plug_id', '') }}">
                    {% if settings.get('interface', {}).get('developer_mode', False) %}
                    <button type="button" class="test-button" onclick="testKillSwitch('plug')">T</button>
                    {% endif %}
                </div>
            </div>
            <div class="form-group">
                <label for="killswitch_api_endpoint" class="tooltip" data-tooltip="Optional HTTP endpoint called when emergency stop is triggered (e.g., to notify external systems or trigger additional safety actions)">Endpoint:</label>
                <div class="input-with-test-button">
                    <input type="url" id="killswitch_api_endpoint" name="killswitch_api_endpoint"
                           value="{{ settings.get('killswitch', {}).get('api_endpoint', '') }}">
                    {% if settings.get('interface', {}).get('developer_mode', False) %}
                    <button type="button" class="test-button" onclick="testKillSwitch('api')">T</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Interface Preferences -->
    <div class="section">
        <h3>Interface Preferences</h3>
        <div class="interface-checkboxes">
            <div class="form-group">
                <input type="checkbox" id="popup_notifications" name="popup_notifications"
                       {% if settings.get('interface', {}).get('popup_notifications', False) %}checked{% endif %}>
                <label for="popup_notifications" class="enable-checkbox tooltip" data-tooltip="Show large visual popups when devices are activated during scenes">Enable Popup Notifications</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="audio_notifications" name="audio_notifications"
                       {% if settings.get('interface', {}).get('audio_notifications', False) %}checked{% endif %}>
                <label for="audio_notifications" class="enable-checkbox tooltip" data-tooltip="Enable text-to-speech audio announcements for device actions and scene events">Enable Audio</label>
            </div>
            <div class="form-group">
                <input type="checkbox" id="developer_mode" name="developer_mode"
                       {% if settings.get('interface', {}).get('developer_mode', False) %}checked{% endif %}>
                <label for="developer_mode" class="enable-checkbox tooltip" data-tooltip="Enable developer features including dry run mode and test buttons for all devices">Developer Mode</label>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button type="submit" class="btn btn-primary">SAVE SETTINGS</button>
        <button type="button" class="btn btn-secondary" onclick="checkForUpdates()">CHECK FOR UPDATES</button>
    </div>
</form>

<!-- Update message display -->
<div id="update-message" class="section" style="display: none; margin-top: 20px;">
    <h3>Update Status</h3>
    <p id="update-text"></p>
    <div id="update-actions" class="control-panel" style="display: none;">
        <button type="button" class="btn btn-success" onclick="performUpdate()">UPDATE</button>
        <button type="button" class="btn btn-secondary" onclick="cancelUpdate()">CANCEL</button>
    </div>
</div>

<!-- Payload Editor Modal -->
<div id="payload-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Payload for Endpoint <span id="endpoint-number"></span></h3>
            <button type="button" class="close-button" onclick="closePayloadModal()">X</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="api-method">API Method:</label>
                <select id="api-method" class="form-control">
                    <option value="POST">POST</option>
                    <option value="GET">GET</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                </select>
            </div>
            <div class="form-group">
                <label for="payload-editor">JSON Payload:</label>
                <textarea id="payload-editor" class="form-control" rows="10" placeholder='{"key": "value", "action": "trigger"}'></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="savePayload()">SAVE</button>
            <button type="button" class="btn btn-success" onclick="testPayload()">TEST</button>
            <button type="button" class="btn btn-secondary" onclick="closePayloadModal()">CANCEL</button>
        </div>
    </div>
</div>

<script>
function checkForUpdates() {
    const button = document.querySelector('button[onclick="checkForUpdates()"]');
    button.disabled = true;
    button.textContent = 'CHECKING...';
    
    fetch('/check_updates')
        .then(response => response.json())
        .then(data => {
            document.getElementById('update-text').textContent = data.message;
            document.getElementById('update-message').style.display = 'block';
            
            // Show update buttons only if update is available
            if (data.update_available) {
                document.getElementById('update-actions').style.display = 'flex';
            } else {
                document.getElementById('update-actions').style.display = 'none';
            }
        })
        .catch(error => {
            document.getElementById('update-text').textContent = 'Error checking for updates: ' + error.message;
            document.getElementById('update-message').style.display = 'block';
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = 'CHECK FOR UPDATES';
        });
}

function performUpdate() {
    const updateButton = document.querySelector('button[onclick="performUpdate()"]');
    const cancelButton = document.querySelector('button[onclick="cancelUpdate()"]');
    
    updateButton.disabled = true;
    cancelButton.disabled = true;
    updateButton.textContent = '⏳ UPDATING...';
    
    fetch('/update_app', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            document.getElementById('update-text').textContent = data.message;
            if (data.success) {
                document.getElementById('update-actions').style.display = 'none';
            }
        })
        .catch(error => {
            document.getElementById('update-text').textContent = 'Update error: ' + error.message;
        })
        .finally(() => {
            updateButton.disabled = false;
            cancelButton.disabled = false;
            updateButton.textContent = 'UPDATE';
        });
}

function cancelUpdate() {
    document.getElementById('update-actions').style.display = 'none';
}

function editPayload(endpointNumber) {
    // Get current payload data if it exists
    const currentPayload = document.getElementById(`custom_${endpointNumber}_payload`)?.value || '{}';
    const currentMethod = document.getElementById(`custom_${endpointNumber}_method`)?.value || 'POST';

    // Set the modal content
    document.getElementById('endpoint-number').textContent = endpointNumber;
    document.getElementById('payload-editor').value = currentPayload;
    document.getElementById('api-method').value = currentMethod;

    // Show the modal
    document.getElementById('payload-modal').style.display = 'flex';
}

function savePayload() {
    const endpointNumber = document.getElementById('endpoint-number').textContent;
    const payload = document.getElementById('payload-editor').value;
    const method = document.getElementById('api-method').value;

    // Validate JSON
    try {
        JSON.parse(payload);
    } catch (e) {
        alert('Invalid JSON format. Please check your syntax.');
        return;
    }

    // Update existing hidden inputs
    const payloadInput = document.getElementById(`custom_${endpointNumber}_payload`);
    const methodInput = document.getElementById(`custom_${endpointNumber}_method`);

    if (payloadInput) {
        payloadInput.value = payload;
    }
    if (methodInput) {
        methodInput.value = method;
    }

    // Close modal
    closePayloadModal();
}

function closePayloadModal() {
    document.getElementById('payload-modal').style.display = 'none';
}

function testPayload() {
    const endpointNumber = document.getElementById('endpoint-number').textContent;
    const payload = document.getElementById('payload-editor').value;
    const method = document.getElementById('api-method').value;

    // Get the endpoint URL from the form
    const endpointInput = document.getElementById(`custom_${endpointNumber}_endpoint`);
    const endpointUrl = endpointInput ? endpointInput.value : '';

    if (!endpointUrl) {
        alert('Please enter an endpoint URL before testing.');
        return;
    }

    // Validate JSON
    try {
        JSON.parse(payload);
    } catch (e) {
        alert('Invalid JSON format. Please check your syntax before testing.');
        return;
    }

    // Disable test button and show loading
    const testButton = document.querySelector('button[onclick="testPayload()"]');
    const originalText = testButton.textContent;
    testButton.disabled = true;
    testButton.textContent = '⏳ TESTING...';

    // Send test request to backend
    fetch('/test_custom_payload', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            endpoint: endpointUrl,
            method: method,
            payload: payload
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Test successful!\n\nStatus: ${data.status_code}\nResponse: ${data.response || 'No response body'}`);
        } else {
            alert(`Test failed!\n\nError: ${data.error}`);
        }
    })
    .catch(error => {
        alert(`Test failed!\n\nNetwork error: ${error.message}`);
    })
    .finally(() => {
        testButton.disabled = false;
        testButton.textContent = originalText;
    });
}

// Developer Mode Test Functions
function testContactSensor(sensorNumber) {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '...';

    // Call the trigger endpoint to activate modifiers (works when scene is running)
    fetch('/trigger' + sensorNumber, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.style.background = '#4CAF50';
            setTimeout(() => {
                button.style.background = '';
            }, 2000);
        } else {
            button.style.background = '#f44336';
            setTimeout(() => {
                button.style.background = '';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.style.background = '#f44336';
        setTimeout(() => {
            button.style.background = '';
        }, 2000);
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function testCustomAccessory(accessoryNumber) {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '...';

    fetch('/test_custom_accessory', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ accessory_number: accessoryNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.style.background = '#4CAF50';
            setTimeout(() => {
                button.style.background = '';
            }, 2000);
        } else {
            button.style.background = '#f44336';
            setTimeout(() => {
                button.style.background = '';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.style.background = '#f44336';
        setTimeout(() => {
            button.style.background = '';
        }, 2000);
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function testMagLock(action) {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '...';

    fetch('/test_maglock', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.style.background = '#4CAF50';
            setTimeout(() => {
                button.style.background = '';
            }, 2000);
        } else {
            button.style.background = '#f44336';
            setTimeout(() => {
                button.style.background = '';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.style.background = '#f44336';
        setTimeout(() => {
            button.style.background = '';
        }, 2000);
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function testKillSwitch(type) {
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = '...';

    fetch('/test_killswitch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.style.background = '#4CAF50';
            setTimeout(() => {
                button.style.background = '';
            }, 2000);
        } else {
            button.style.background = '#f44336';
            setTimeout(() => {
                button.style.background = '';
            }, 2000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.style.background = '#f44336';
        setTimeout(() => {
            button.style.background = '';
        }, 2000);
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

// Handle settings form submission with AJAX
document.addEventListener('DOMContentLoaded', function() {
    const settingsForm = document.getElementById('settings-form');
    if (settingsForm) {
        settingsForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission

            // Get form data
            const formData = new FormData(this);

            // Submit via AJAX
            fetch('/save_settings', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    showSaveSuccess();
                } else {
                    throw new Error('Save failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Could add error popup here if needed
            });
        });
    }

    // Mask all input fields (except checkboxes and hidden inputs)
    const allInputs = document.querySelectorAll('#settings-form input[type="text"], #settings-form input[type="url"]');

    allInputs.forEach(field => {
        if (field && field.value) {
            // Store original type
            field.dataset.originalType = field.type;
            // Mask the value
            field.type = 'password';

            // Unmask on focus
            field.addEventListener('focus', function() {
                this.type = this.dataset.originalType || 'text';
            });

            // Re-mask on blur if not empty
            field.addEventListener('blur', function() {
                if (this.value) {
                    this.type = 'password';
                }
            });
        }
    });
});

// Show save success popup
function showSaveSuccess() {
    const popup = document.getElementById('save-success-popup');
    if (popup) {
        // Reset to default save message
        popup.innerHTML = 'Save successful';
        popup.classList.add('show');
        // Hide after 2 seconds
        setTimeout(() => {
            popup.classList.remove('show');
            popup.classList.add('hide');
            // Clean up hide class after animation
            setTimeout(() => {
                popup.classList.remove('hide');
            }, 400);
        }, 2000);
    }
}
</script>
{% endblock %}